const accaunt1 = {
  useName: "Николай",
  iphone: +79964179001,
  transaction: [800, -150, 1500, -500, -170, -37, 5000, 1470, -800, 450],
  interestBalans: 1.8,
  password: 1111,
  transactionDate: [
    "Tue Feb 14 2023 09:55:45",
    "Tue Feb 14 2023 14:16:45",
    "Tue Feb 15 2023 17:32:45",
    "Tue Feb 16 2023 18:02:45",
    "Tue Feb 16 2023 23:32:45",
    "Tue Feb 17 2023 13:52:45",
    "Tue Feb 18 2023 10:12:45",
    "Tue Feb 19 2023 17:33:45",
    "Tue Feb 20 2023 11:13:45",
    "Tue Feb 21 2023 16:32:45",
  ],
  currency: "RUB",
  locale: "ru-RU",
};
const accaunt2 = {
  useName: "Татьяна",
  iphone: +79886298315,
  transaction: [5500, -150, 15000, 800, -100, -137, 5000, -1770, -620, 40070],
  interestBalans: 1.7,
  password: 2222,
  transactionDate: [
    "Tue Feb 1 2023 14:16:45",
    "Tue Feb 4 2023 09:55:45",
    "Tue Feb 7 2023 10:12:45",
    "Tue Feb 7 2023 17:32:45",
    "Tue Feb 10 2023 23:32:45",
    "Tue Feb 16 2023 18:02:45",
    "Tue Feb 17 2023 13:52:45",
    "Tue Feb 19 2023 11:13:45",
    "Tue Feb 19 2023 17:33:45",
    "Tue Feb 21 2023 16:32:45",
  ],
  currency: "RUB",
  locale: "ru-RU",
};
const accaunt3 = {
  useName: "Денис",
  iphone: +79064111997,
  transaction: [1500, 1050, 1740, -420, -100, 1370, 3500, -1770, -620, 470],
  interestBalans: 1.2,
  password: 3333,
  transactionDate: [
    "Tue Feb 14 2023 09:55:45",
    "Tue Feb 14 2023 14:16:45",
    "Tue Feb 15 2023 17:32:45",
    "Tue Feb 16 2023 18:02:45",
    "Tue Feb 16 2023 23:32:45",
    "Tue Feb 17 2023 13:52:45",
    "Tue Feb 18 2023 10:12:45",
    "Tue Feb 19 2023 17:33:45",
    "Tue Feb 20 2023 11:13:45",
    "Tue Feb 21 2023 16:32:45",
  ],
  currency: "RUB",
  locale: "ru-RU",
};
const accaunt4 = {
  useName: "Юленэ",
  iphone: +79624254996,
  transaction: [1200, -360, 1600, -120, -100, -137, 2150, -1770, 620, 470],
  interestBalans: 1.4,
  password: 4444,
  transactionDate: [
    "Tue Feb 14 2023 09:55:45",
    "Tue Feb 14 2023 14:16:45",
    "Tue Feb 15 2023 17:32:45",
    "Tue Feb 17 2023 13:52:45",
    "Tue Feb 16 2023 18:02:45",
    "Tue Feb 16 2023 23:32:45",
    "Tue Feb 18 2023 10:12:45",
    "Tue Feb 19 2023 17:33:45",
    "Tue Feb 20 2023 11:13:45",
    "Tue Feb 21 2023 16:32:45",
  ],
  currency: "RUB",
  locale: "ru-RU",
};
const accaunt5 = {
  useName: "Ирина",
  iphone: +79880886141,
  transaction: [-5000, -360, 16000, 1200, -100, -1370, 2150, -1770, -620, 4070],
  interestBalans: 1.1,
  password: 5555,
  transactionDate: [
    "Tue Feb 14 2023 09:55:45",
    "Tue Feb 14 2023 14:16:45",
    "Tue Feb 15 2023 17:32:45",
    "Tue Feb 16 2023 18:02:45",
    "Tue Feb 16 2023 23:32:45",
    "Tue Feb 17 2023 13:52:45",
    "Tue Feb 18 2023 10:12:45",
    "Tue Feb 19 2023 17:33:45",
    "Tue Feb 20 2023 11:13:45",
    "Tue Feb 21 2023 16:32:45",
  ],
  currency: "RUB",
  locale: "ru-RU",
};
const accaunt6 = {
  useName: "Иван",
  iphone: +79288224690,
  transaction: [120, -3060, 1600, -120, -1000, -137, 2550, 1770, -620, 4070],
  interestBalans: 1.9,
  password: 6666,
  transactionDate: [
    "Tue Feb 14 2023 09:55:45",
    "Tue Feb 14 2023 14:16:45",
    "Tue Feb 15 2023 17:32:45",
    "Tue Feb 16 2023 18:02:45",
    "Tue Feb 16 2023 23:32:45",
    "Tue Feb 17 2023 13:52:45",
    "Tue Feb 18 2023 10:12:45",
    "Tue Feb 19 2023 17:33:45",
    "Tue Feb 20 2023 11:13:45",
    "Tue Feb 21 2023 16:32:45",
  ],
  currency: "RUB",
  locale: "ru-RU",
};
const accaunt7 = {
  useName: "Антонио",
  iphone: +79624333191,
  transaction: [12000, -3060, -1600, -180, 1000, -137, 2150, -1770, -620, -470],
  interestBalans: 1.3,
  password: 7777,
  transactionDate: [
    "Tue Feb 2 2023 14:16:45",
    "Tue Feb 9 2023 09:55:45",
    "Tue Feb 15 2023 17:32:45",
    "Tue Feb 16 2023 18:02:45",
    "Tue Feb 16 2023 23:32:45",
    "Tue Feb 16 2023 13:52:45",
    "Tue Feb 18 2023 10:12:45",
    "Tue Feb 18 2023 17:33:45",
    "Tue Feb 20 2023 11:13:45",
    "Tue Feb 21 2023 16:32:45",
  ],
  currency: "RUB",
  locale: "ru-RU",
};
const accounts = [
  accaunt1,
  accaunt2,
  accaunt3,
  accaunt4,
  accaunt5,
  accaunt6,
  accaunt7,
];

///////////////////////////////////////////////////////
//Блоки
let displayTransaction = document.querySelector(".display-transaction");
let commonWrapper = document.querySelector(".wrapper-content");
//Кнопки
let btnLoginBank = document.querySelector(".header__btn-login");
let btnCloseBank = document.querySelector(".header__btn-close");
let btnCredit = document.querySelector(".credit__btn-credit");
let btnTransaction = document.querySelector(".translation__btn-trans");
let btnSorting = document.querySelector(".account-summary__sorting-btn");
//Формы
let inputNicknameLogin = document.querySelector(".header__nike-name");
let inputPasswordLogin = document.querySelector(".header__password");
let creditInput = document.querySelector(".credit__input");
let translationInput = document.querySelector("#transaction-input");
let transactionSumInput = document.querySelector("#transaction-sum");
//Строки
let labelDeposi = document.querySelector(".receiving");
let labelSpent = document.querySelector(".spent");
let labelPercent = document.querySelector(".percent");
let currentBalanse = document.querySelector(
  ".account-details__current-balance"
);
let currentDate = document.querySelector(".account-details__current-date");
let dateOperation = document.querySelector(
  ".display-transaction__date-operation"
);
let blokTranslationText = document.querySelector(".translation__action-name");
let blokCreditText = document.querySelector(".credit__action-name");
let labelTime = document.querySelector(".time");
//////////////////////////////////////////////////////
const formatCurrency = function (value, locale, currency) {
  return Intl.NumberFormat(locale, {
    style: "currency",
    currency: currency,
  }).format(value);
};

const getTransaction = function (accaunt, sort = false) {
  displayTransaction.innerHTML = "";

  let transSort = sort
    ? accaunt.transaction.slice().sort((x, y) => x - y)
    : accaunt.transaction;

  transSort.forEach(function (trans, index) {
    const operationClass = trans > 0 ? "deposit" : "write-offs";
    const operationText = trans > 0 ? "Пополнение" : "Списание";

    let transDate = new Date(accaunt.transactionDate[index]);
    let dates = `${transDate.getDate()}`.padStart(2, "0");
    let month = `${transDate.getMonth()}`.padStart(2, "0");
    let year = transDate.getFullYear();

    let date = `${dates}.${month}.${year}`;

    let formatTrans = formatCurrency(trans, accaunt.locale, accaunt.currency);

    const transactionRow = `
      <div class="display-transaction__row">
        <h2 class="display-transaction__${operationClass}">${operationText}</h2>
        <h2 class="display-transaction__date-operation">${date}</h2>
        <h2 class="display-transaction__amount">${formatTrans}</h2>
      </div>
     `;

    displayTransaction.insertAdjacentHTML("afterbegin", transactionRow);
  });
};

const getBalanse = function (accaunt) {
  let balance = accaunt.transaction.reduce((acc, item) => acc + item);
  accaunt.balance = balance;
  currentBalanse.textContent = formatCurrency(
    balance,
    accaunt.locale,
    accaunt.currency
  );
};

const getFinalBalance = function (accaunt) {
  let depositTotal = accaunt.transaction
    .filter((trans) => trans > 0)
    .reduce((acc, item) => acc + item);

  let spentTotal = accaunt.transaction
    .filter((trans) => trans < 0)
    .reduce((acc, item) => acc + item);

  let percentTotal = accaunt.transaction
    .filter((trans) => trans > 0)
    .map((dep) => (dep * accaunt.interestBalans) / 100)
    .reduce((acc, precent) => acc + precent);

  labelSpent.textContent = formatCurrency(
    spentTotal,
    accaunt.locale,
    accaunt.currency
  );
  labelDeposi.textContent = formatCurrency(
    depositTotal,
    accaunt.locale,
    accaunt.currency
  );
  labelPercent.textContent = formatCurrency(
    percentTotal,
    accaunt.locale,
    accaunt.currency
  );
};

const updateUI = function (accaunt) {
  getTransaction(accaunt);
  getBalanse(accaunt);
  getFinalBalance(accaunt);
};

let currentAccaunt, currentTime;
// currentAccaunt = accaunt1;
// updateUI(currentAccaunt);

btnLoginBank.addEventListener("click", function (event) {
  event.preventDefault();

  let nickname = Number(inputNicknameLogin.value);
  let password = Number(inputPasswordLogin.value);

  currentAccaunt = accounts.find((account) => account.iphone === nickname);

  if (currentAccaunt?.password === password) {
    inputNicknameLogin.value = "";
    inputPasswordLogin.value = "";
    commonWrapper.style.visibility = "visible";
    document.querySelector(
      ".header__users-greeting"
    ).innerHTML = `<h1 class="header__users-greeting">Рады, что вы снова с нами <span class="header__user-name">${currentAccaunt.useName}</span></h1>`;
    document.querySelector(
      ".header__users-greeting-forma"
    ).innerHTML = `<h1 class="header__users-greeting-forma">Рады, что вы снова с нами<br><span class="header__user-name">${currentAccaunt.useName}</span></h1>`;

    if (currentTime) clearInterval(currentTime);
    currentTime = startLogoutTime();
    updateUI(currentAccaunt);
  }
});

btnTransaction.addEventListener("click", function (event) {
  event.preventDefault();

  let iphoneTransaction = Number(translationInput.value);
  let transactionAmount = Math.floor(Number(transactionSumInput.value));
  let recipientAccount = accounts.find(
    (accaunt) => accaunt.iphone === iphoneTransaction
  );

  if (
    iphoneTransaction &&
    transactionAmount &&
    transactionAmount > 0 &&
    recipientAccount &&
    transactionAmount <= currentAccaunt.balance &&
    recipientAccount.iphone !== currentAccaunt.iphone
  ) {
    setInterval(function () {
      currentAccaunt.transaction.push(-transactionAmount);
      recipientAccount.transaction.push(transactionAmount);
      currentAccaunt.transactionDate.push(new Date());
      recipientAccount.transactionDate.push(new Date());
      updateUI(currentAccaunt);
      translationInput.value = "";
      transactionSumInput.value = "";
      blokTranslationText.textContent = "Перевести деньги";
      clearInterval(currentTime);
      currentTime = startLogoutTime();
    }, 5000);
    translationInput.value = "";
    transactionSumInput.value = "";
    blokTranslationText.textContent = "Ожидайте перевод";
  } else if (transactionAmount > currentAccaunt.balance) {
    blokTranslationText.textContent = "Недостаточно средств для перевода";
  } else if (recipientAccount?.iphone === currentAccaunt.iphone) {
    blokTranslationText.textContent = "Перевод самому себе не возможен";
  } else {
    blokTranslationText.textContent = "Пользователь не найден";
  }
});

btnCredit.addEventListener("click", function (event) {
  event.preventDefault();
  let creditAmout = Math.floor(Number(creditInput.value));
  let middleShoulder = (creditAmout / currentAccaunt.balance) * 100;

  if (middleShoulder < 40) {
    if (creditAmout) {
      blokCreditText.textContent = "Ожидайте займ";
      setInterval(function () {
        currentAccaunt.transaction.push(creditAmout);
        currentAccaunt.transactionDate.push(new Date());
        updateUI(currentAccaunt);
        clearInterval(currentTime);
        currentTime = startLogoutTime();
        blokCreditText.textContent = "Запросить займ";
      }, 5000);
    } else if (creditInput.value.length === 0) {
      blokCreditText.textContent = "Ведите сумму займа";
    }
  } else {
    blokCreditText.textContent = "Слишком большая сумма займа";
  }

  creditInput.value = "";
});

let transSotr = true;

btnSorting.addEventListener("click", function (event) {
  event.preventDefault();

  getTransaction(currentAccaunt, !transSotr);
  transSotr = !transSotr;
});

const startLogoutTime = function () {
  const logOutTimeCallback = function () {
    let minutes = String(Math.trunc(time / 60)).padStart(2, "0");
    let second = String(time % 60).padStart(2, "0");

    labelTime.textContent = `${minutes}:${second}`;

    if (time === 0) {
      clearInterval(logOutTime);
      commonWrapper.style.visibility = "hidden";
      document.querySelector(
        ".header__users-greeting"
      ).innerHTML = `<h1 class="header__users-greeting">Войдите в свой аккаунт <span class="header__user-name"></span></h1>`;
      document.querySelector(
        ".header__users-greeting-forma"
      ).innerHTML = `<h1 class="header__users-greeting-forma">Войдите в свой аккаунт <br><span class="header__user-name"></span></h1>`;
    }
    time--;
  };
  let time = 300;
  logOutTimeCallback();
  const logOutTime = setInterval(logOutTimeCallback, 1000);
  return logOutTime;
};

btnCloseBank.addEventListener("click", function (event) {
  event.preventDefault();
  commonWrapper.style.visibility = "hidden";
});
